<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Browser Dashboard - Spr√°va √∫ƒçt≈Ø</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 32px;
      color: #333;
      margin-bottom: 10px;
    }

    .header p {
      color: #666;
      font-size: 16px;
    }

    .stats-row {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .stat-card {
      background: white;
      padding: 20px 30px;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      flex: 1;
      min-width: 200px;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .stat-icon {
      font-size: 36px;
    }

    .stat-content h3 {
      font-size: 14px;
      color: #666;
      margin-bottom: 5px;
      font-weight: 500;
    }

    .stat-content .stat-number {
      font-size: 28px;
      font-weight: bold;
      color: #333;
    }

    .accounts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
      gap: 20px;
    }

    .account-card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
      padding: 20px;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .account-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }

    .account-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }

    .account-title {
      flex: 1;
    }

    .account-title h3 {
      font-size: 18px;
      color: #333;
      margin-bottom: 5px;
    }

    .account-title .world {
      font-size: 14px;
      color: #666;
    }

    .status-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      white-space: nowrap;
    }

    .status-ok {
      background: #e7f8ed;
      color: #2d7a4f;
    }

    .status-login {
      background: #fff3cd;
      color: #856404;
    }

    .status-captcha {
      background: #f8d7da;
      color: #721c24;
    }

    .status-conquered {
      background: #d6d8db;
      color: #383d41;
    }

    .status-paused {
      background: #cce5ff;
      color: #004085;
    }

    .account-info {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 15px;
      font-size: 13px;
      color: #666;
    }

    .account-info div {
      margin-bottom: 6px;
    }

    .account-info div:last-child {
      margin-bottom: 0;
    }

    .account-info strong {
      color: #333;
      font-weight: 600;
    }

    .account-actions {
      display: flex;
      gap: 10px;
    }

    .btn {
      flex: 1;
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-success {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      color: white;
    }

    .btn-warning {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .empty-state {
      background: white;
      padding: 60px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .empty-state h2 {
      font-size: 24px;
      color: #666;
      margin-bottom: 10px;
    }

    .empty-state p {
      color: #999;
      font-size: 16px;
    }

    .filter-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .filter-tab {
      padding: 10px 20px;
      background: white;
      border: 2px solid transparent;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .filter-tab:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .filter-tab.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: white;
      font-size: 18px;
    }

    /* Notification */
    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      color: white;
      font-weight: 600;
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .notification.success {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }

    .notification.error {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üñ•Ô∏è Browser Dashboard</h1>
      <p>Spr√°va viditeln√Ωch prohl√≠≈æeƒç≈Ø pro v≈°echny √∫ƒçty</p>
    </div>

    <!-- Statistiky -->
    <div class="stats-row">
      <div class="stat-card">
        <div class="stat-icon">üìä</div>
        <div class="stat-content">
          <h3>Celkem √∫ƒçt≈Ø</h3>
          <div class="stat-number" id="stat-total">0</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">‚úÖ</div>
        <div class="stat-content">
          <h3>P≈ôipraveno</h3>
          <div class="stat-number" id="stat-ok">0</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üîë</div>
        <div class="stat-content">
          <h3>Pot≈ôebuje p≈ôihl√°≈°en√≠</h3>
          <div class="stat-number" id="stat-login">0</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">ü§ñ</div>
        <div class="stat-content">
          <h3>CAPTCHA</h3>
          <div class="stat-number" id="stat-captcha">0</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon">üè¥</div>
        <div class="stat-content">
          <h3>Dobyt√Ω</h3>
          <div class="stat-number" id="stat-conquered">0</div>
        </div>
      </div>
    </div>

    <!-- Filtry -->
    <div class="filter-tabs">
      <div class="filter-tab active" data-filter="all">V≈°echny</div>
      <div class="filter-tab" data-filter="needs-login">üîë Pot≈ôebuje p≈ôihl√°≈°en√≠</div>
      <div class="filter-tab" data-filter="captcha">ü§ñ CAPTCHA</div>
      <div class="filter-tab" data-filter="conquered">üè¥ Dobyt√Ω</div>
      <div class="filter-tab" data-filter="paused">‚è∏Ô∏è Pozastaveno</div>
    </div>

    <!-- Grid s √∫ƒçty -->
    <div id="accounts-container" class="loading">
      Naƒç√≠t√°m √∫ƒçty...
    </div>
  </div>

  <script>
    let accounts = [];
    let currentFilter = 'all';

    // Naƒçten√≠ √∫ƒçt≈Ø
    async function loadAccounts() {
      try {
        const response = await fetch('/api/accounts');
        accounts = await response.json();
        updateStats();
        renderAccounts();
      } catch (error) {
        showNotification('Chyba p≈ôi naƒç√≠t√°n√≠ √∫ƒçt≈Ø: ' + error.message, 'error');
      }
    }

    // Aktualizace statistik
    function updateStats() {
      const stats = {
        total: accounts.length,
        ok: 0,
        login: 0,
        captcha: 0,
        conquered: 0
      };

      accounts.forEach(acc => {
        const status = getAccountStatus(acc);
        if (status === 'ok') stats.ok++;
        else if (status === 'needs-login') stats.login++;
        else if (status === 'captcha') stats.captcha++;
        else if (status === 'conquered') stats.conquered++;
      });

      document.getElementById('stat-total').textContent = stats.total;
      document.getElementById('stat-ok').textContent = stats.ok;
      document.getElementById('stat-login').textContent = stats.login;
      document.getElementById('stat-captcha').textContent = stats.captcha;
      document.getElementById('stat-conquered').textContent = stats.conquered;
    }

    // Urƒçen√≠ statusu √∫ƒçtu
    function getAccountStatus(account) {
      // Dobyt√° vesnice
      if (account.village_conquered) {
        return 'conquered';
      }

      // CAPTCHA (pausnut√Ω + pozn√°mka obsahuje captcha)
      if (account.paused && account.pause_note && account.pause_note.includes('captcha')) {
        return 'captcha';
      }

      // Pozastaven√Ω
      if (account.paused) {
        return 'paused';
      }

      // Pot≈ôebuje p≈ôihl√°≈°en√≠ (nem√° cookies nebo jsou null)
      if (!account.cookies || account.cookies === 'null') {
        return 'needs-login';
      }

      // Jinak OK
      return 'ok';
    }

    // Renderov√°n√≠ √∫ƒçt≈Ø
    function renderAccounts() {
      const container = document.getElementById('accounts-container');

      // Filtrov√°n√≠
      let filteredAccounts = accounts;
      if (currentFilter === 'needs-login') {
        filteredAccounts = accounts.filter(acc => getAccountStatus(acc) === 'needs-login');
      } else if (currentFilter === 'captcha') {
        filteredAccounts = accounts.filter(acc => getAccountStatus(acc) === 'captcha');
      } else if (currentFilter === 'conquered') {
        filteredAccounts = accounts.filter(acc => getAccountStatus(acc) === 'conquered');
      } else if (currentFilter === 'paused') {
        filteredAccounts = accounts.filter(acc => acc.paused);
      }

      if (filteredAccounts.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <h2>≈Ω√°dn√© √∫ƒçty</h2>
            <p>Nena≈°ly se ≈æ√°dn√© √∫ƒçty pro tento filtr.</p>
          </div>
        `;
        return;
      }

      container.className = 'accounts-grid';
      container.innerHTML = filteredAccounts.map(account => {
        const status = getAccountStatus(account);
        const statusLabel = {
          'ok': 'P≈ôipraven',
          'needs-login': 'Pot≈ôebuje p≈ôihl√°≈°en√≠',
          'captcha': 'CAPTCHA',
          'conquered': 'Dobyt√Ω',
          'paused': 'Pozastaveno'
        }[status];

        const statusClass = {
          'ok': 'status-ok',
          'needs-login': 'status-login',
          'captcha': 'status-captcha',
          'conquered': 'status-conquered',
          'paused': 'status-paused'
        }[status];

        return `
          <div class="account-card">
            <div class="account-header">
              <div class="account-title">
                <h3>${account.username}</h3>
                <div class="world">${account.world || 'Svƒõt neurƒçen'}</div>
              </div>
              <div class="status-badge ${statusClass}">${statusLabel}</div>
            </div>

            <div class="account-info">
              ${account.village_name ? `<div><strong>Vesnice:</strong> ${account.village_name} (${account.coord_x}|${account.coord_y})</div>` : ''}
              ${account.tribe_name ? `<div><strong>Kmen:</strong> ${account.tribe_name}</div>` : ''}
              ${account.points ? `<div><strong>Body:</strong> ${account.points.toLocaleString()}</div>` : ''}
              ${account.pause_note ? `<div><strong>Pozn√°mka:</strong> ${account.pause_note}</div>` : ''}
            </div>

            <div class="account-actions">
              <button class="btn btn-primary" onclick="switchToBrowser(${account.id})">
                üñ•Ô∏è P≈ôepnout
              </button>
              ${status === 'needs-login' || status === 'captcha' || status === 'conquered' ? `
                <button class="btn btn-warning" onclick="openBrowser(${account.id})">
                  üîß Otev≈ô√≠t
                </button>
              ` : ''}
              ${account.paused ? `
                <button class="btn btn-success" onclick="unpauseAccount(${account.id})">
                  ‚ñ∂Ô∏è Aktivovat
                </button>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
    }

    // P≈ôepnut√≠ na browser (focus)
    async function switchToBrowser(accountId) {
      try {
        const response = await fetch(`/api/accounts/${accountId}/focus-browser`, {
          method: 'POST'
        });
        const result = await response.json();

        if (result.success) {
          showNotification('Browser byl aktivov√°n', 'success');
        } else {
          showNotification('Chyba: ' + result.error, 'error');
        }
      } catch (error) {
        showNotification('Chyba p≈ôi p≈ôep√≠n√°n√≠: ' + error.message, 'error');
      }
    }

    // Otev≈ôen√≠ browseru
    async function openBrowser(accountId) {
      try {
        const response = await fetch(`/api/accounts/${accountId}/open-browser`, {
          method: 'POST'
        });
        const result = await response.json();

        if (result.success) {
          showNotification('Browser byl otev≈ôen', 'success');
          // Reload √∫ƒçt≈Ø po 2s
          setTimeout(() => loadAccounts(), 2000);
        } else {
          showNotification('Chyba: ' + result.error, 'error');
        }
      } catch (error) {
        showNotification('Chyba p≈ôi otev√≠r√°n√≠: ' + error.message, 'error');
      }
    }

    // Unpause √∫ƒçtu
    async function unpauseAccount(accountId) {
      try {
        const response = await fetch(`/api/accounts/${accountId}/pause`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ paused: false })
        });
        const result = await response.json();

        if (result.success) {
          showNotification('√öƒçet byl aktivov√°n', 'success');
          loadAccounts();
        } else {
          showNotification('Chyba: ' + result.error, 'error');
        }
      } catch (error) {
        showNotification('Chyba p≈ôi aktivaci: ' + error.message, 'error');
      }
    }

    // Notifikace
    function showNotification(message, type = 'success') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);

      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    // Filtry
    document.querySelectorAll('.filter-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentFilter = tab.dataset.filter;
        renderAccounts();
      });
    });

    // Automatick√© obnovov√°n√≠ ka≈æd√Ωch 10s
    setInterval(() => {
      loadAccounts();
    }, 10000);

    // Naƒçten√≠ p≈ôi startu
    loadAccounts();
  </script>
</body>
</html>
