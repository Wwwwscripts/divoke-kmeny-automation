<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>≈†ablony tr√©ninku - Divok√© kmeny</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            padding: 0;
            min-height: 100vh;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header s vyhled√°v√°n√≠m */
        .header {
            background: linear-gradient(135deg, #161b22 0%, #1c2128 100%);
            border-bottom: 1px solid #30363d;
            padding: 15px 0;
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1800px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            font-size: 1.5em;
            font-weight: 700;
            background: linear-gradient(135deg, #58a6ff, #79c0ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            white-space: nowrap;
            cursor: pointer;
        }

        /* Velk√© vyhled√°vac√≠ pole */
        .search-container {
            flex: 1;
            max-width: 600px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 12px 45px 12px 45px;
            background: #0d1117;
            border: 2px solid #30363d;
            border-radius: 8px;
            color: #c9d1d9;
            font-size: 15px;
            transition: all 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: #58a6ff;
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 18px;
            color: #8b949e;
        }

        .search-clear {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #8b949e;
            cursor: pointer;
            font-size: 18px;
            display: none;
        }

        .search-input:not(:placeholder-shown) ~ .search-clear {
            display: block;
        }

        /* Navigace */
        .nav {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .nav-btn {
            background: #21262d;
            color: #c9d1d9;
            border: 1px solid #30363d;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .nav-btn:hover {
            background: #30363d;
            border-color: #8b949e;
        }

        .nav-btn.danger {
            background: #da3633;
            border-color: #da3633;
            color: white;
        }

        .nav-btn.danger:hover {
            background: #f85149;
        }

        /* Dropdown menu */
        .dropdown {
            position: relative;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            margin-top: 5px;
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            min-width: 200px;
            z-index: 1000;
        }

        .dropdown.active .dropdown-content {
            display: block;
        }

        .dropdown-item {
            padding: 10px 16px;
            cursor: pointer;
            color: #c9d1d9;
            transition: background 0.2s;
            border-bottom: 1px solid #30363d;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: #21262d;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid #30363d;
            padding-bottom: 0;
        }

        .tab {
            background: transparent;
            color: #8b949e;
            border: none;
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 14px;
            border-bottom: 2px solid transparent;
        }

        .tab:hover {
            color: #c9d1d9;
        }

        .tab.active {
            color: #58a6ff;
            border-bottom-color: #58a6ff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Templates grid */
        .templates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .template-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 20px;
            transition: border-color 0.2s;
        }

        .template-card:hover {
            border-color: #58a6ff;
        }

        .template-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #30363d;
        }

        .template-name {
            background: #0d1117;
            color: #c9d1d9;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #30363d;
            font-size: 14px;
            font-weight: 600;
            width: 200px;
            transition: all 0.2s;
        }

        .template-name:focus {
            outline: none;
            border-color: #58a6ff;
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
        }

        .template-actions {
            display: flex;
            gap: 8px;
        }

        .template-units {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .unit-row {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #0d1117;
            padding: 8px 12px;
            border-radius: 6px;
            border: 1px solid #21262d;
        }

        .unit-icon {
            width: 30px;
            font-size: 20px;
        }

        .unit-label {
            flex: 1;
            color: #8b949e;
            font-weight: 600;
            font-size: 13px;
        }

        .unit-input {
            width: 80px;
            padding: 6px 8px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 4px;
            color: #c9d1d9;
            text-align: right;
            font-size: 13px;
            transition: all 0.2s;
        }

        .unit-input:focus {
            outline: none;
            border-color: #58a6ff;
            box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.1);
        }

        .btn-save {
            background: #238636;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: background 0.2s;
        }

        .btn-save:hover {
            background: #2ea043;
        }

        .btn-delete {
            background: #da3633;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 13px;
            transition: background 0.2s;
        }

        .btn-delete:hover {
            background: #f85149;
        }

        .btn-add {
            background: #238636;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 20px;
            transition: background 0.2s;
        }

        .btn-add:hover {
            background: #2ea043;
        }

        .message {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .message-success {
            background: rgba(35, 134, 54, 0.15);
            color: #3fb950;
            border: 1px solid rgba(35, 134, 54, 0.4);
        }

        .message-error {
            background: rgba(248, 81, 73, 0.15);
            color: #f85149;
            border: 1px solid rgba(248, 81, 73, 0.4);
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #8b949e;
            font-size: 15px;
        }
    </style>
</head>
<body>
    <!-- Header s vyhled√°v√°n√≠m -->
    <div class="header">
        <div class="header-content">
            <div class="logo" onclick="window.location.href='/'">‚öîÔ∏è Divok√© kmeny</div>

            <div class="search-container">
                <span class="search-icon">üîç</span>
                <input type="text"
                       id="searchInput"
                       class="search-input"
                       placeholder="Hledat √∫ƒçet podle jm√©na, svƒõta...">
                <button class="search-clear" onclick="clearSearch()">‚úï</button>
            </div>

            <div class="nav">
                <button class="nav-btn danger" onclick="window.location.href='/attacks.html'">
                    üö® √ötoky <span id="attackCount"></span>
                </button>
                <button class="nav-btn" onclick="window.location.href='/units.html'">
                    ‚öîÔ∏è Jednotky
                </button>
                <button class="nav-btn" onclick="window.location.href='/'">
                    üîÑ
                </button>

                <div class="dropdown" id="moreMenu">
                    <button class="nav-btn" onclick="toggleDropdown()">‚ãØ</button>
                    <div class="dropdown-content">
                        <div class="dropdown-item" onclick="window.location.href='/accounts.html'">
                            ‚ûï P≈ôidat √∫ƒçet
                        </div>
                        <div class="dropdown-item" onclick="window.location.href='/training-templates.html'">
                            üìã ≈†ablony tr√©ninku
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div id="message"></div>

        <!-- Z√°lo≈æky -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('recruit')">üìã Rekrutov√°n√≠</button>
            <button class="tab" onclick="switchTab('research')">üî¨ V√Ωzkum</button>
            <button class="tab" onclick="window.location.href='/world-settings.html'">üåç Svƒõty</button>
        </div>

        <!-- REKRUTOV√ÅN√ç -->
        <div id="recruit-tab" class="tab-content active">
            <button class="btn-add" onclick="addRecruitTemplate()">‚ûï P≈ôidat ≈°ablonu rekrutu</button>
            <div class="templates-grid" id="recruitTemplatesGrid">
                <div class="loading">‚è≥ Naƒç√≠t√°m...</div>
            </div>
        </div>

        <!-- V√ùZKUM -->
        <div id="research-tab" class="tab-content">
            <button class="btn-add" onclick="addResearchTemplate()">‚ûï P≈ôidat ≈°ablonu v√Ωzkumu</button>
            <div class="templates-grid" id="researchTemplatesGrid">
                <div class="loading">‚è≥ Naƒç√≠t√°m...</div>
            </div>
        </div>
    </div>

    <script>
        // Definice jednotek
        const units = [
            { id: 'spear', name: 'Kopin√≠k', icon: 'üõ°Ô∏è' },
            { id: 'sword', name: 'Meƒçn√≠k', icon: '‚öîÔ∏è' },
            { id: 'axe', name: 'Sekyrn√≠k', icon: 'ü™ì' },
            { id: 'archer', name: 'Luƒçi≈°tn√≠k', icon: 'üèπ' },
            { id: 'spy', name: 'Zvƒõd', icon: 'üëÅÔ∏è' },
            { id: 'light', name: 'Lehk√° j√≠zda', icon: 'üêé' },
            { id: 'marcher', name: 'Luƒçi≈°tn√≠k na koni', icon: 'üèá' },
            { id: 'heavy', name: 'Tƒõ≈æk√° j√≠zda', icon: 'üê¥' },
            { id: 'ram', name: 'Beranidlo', icon: 'üêè' },
            { id: 'catapult', name: 'Katapult', icon: '‚öôÔ∏è' },
            { id: 'knight', name: 'Ryt√≠≈ô', icon: 'ü§¥' },
            { id: 'snob', name: '≈†lechtic', icon: 'üëë' }
        ];

        // Defaultn√≠ ≈°ablony pro rekrut
        const defaultRecruitTemplates = [
            { id: 'FARM', name: 'FARM', units: { spear: 0, sword: 0, axe: 300, light: 0, marcher: 0, heavy: 0 } },
            { id: 'DEF', name: 'DEF', units: { spear: 300, sword: 300, archer: 100, heavy: 50 } },
            { id: 'OFF', name: 'OFF', units: { axe: 0, light: 500, marcher: 0, ram: 50, catapult: 20 } }
        ];

        // Defaultn√≠ ≈°ablony pro v√Ωzkum
        const defaultResearchTemplates = [
            {
                id: 'FARM',
                name: 'FARM',
                levels: {
                    spear: 0, sword: 0, axe: 3, archer: 0, spy: 0,
                    light: 0, marcher: 0, heavy: 0, ram: 0, catapult: 0, knight: 0, snob: 0
                }
            },
            {
                id: 'DEF',
                name: 'DEF',
                levels: {
                    spear: 3, sword: 3, archer: 3, spy: 2,
                    light: 0, marcher: 0, heavy: 3, ram: 0, catapult: 0, knight: 0, snob: 0
                }
            },
            {
                id: 'OFF',
                name: 'OFF',
                levels: {
                    spear: 0, sword: 0, axe: 3, spy: 2,
                    light: 3, marcher: 3, heavy: 0, ram: 3, catapult: 3, knight: 0, snob: 0
                }
            }
        ];

        let recruitTemplates = [];
        let researchTemplates = [];

        // Dropdown menu
        function toggleDropdown() {
            document.getElementById('moreMenu').classList.toggle('active');
        }

        // Zav≈ô√≠t dropdown p≈ôi kliku mimo
        document.addEventListener('click', (e) => {
            const dropdown = document.getElementById('moreMenu');
            if (!dropdown.contains(e.target)) {
                dropdown.classList.remove('active');
            }
        });

        // Vyƒçistit vyhled√°v√°n√≠
        function clearSearch() {
            document.getElementById('searchInput').value = '';
        }

        // P≈ôep√≠n√°n√≠ z√°lo≈æek
        function switchTab(tabName) {
            // Odznaƒç v≈°echny z√°lo≈æky
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Oznaƒç aktivn√≠ z√°lo≈æku
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
        }

        // ============ REKRUTOV√ÅN√ç ============
        async function loadRecruitTemplates() {
            const grid = document.getElementById('recruitTemplatesGrid');
            grid.innerHTML = '<div class="loading">‚è≥ Naƒç√≠t√°m...</div>';

            try {
                const response = await fetch('/api/templates/recruit');
                recruitTemplates = await response.json();

                if (!recruitTemplates || recruitTemplates.length === 0) {
                    recruitTemplates = defaultRecruitTemplates;
                }

                renderRecruitTemplates();
            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ ≈°ablon:', error);
                recruitTemplates = defaultRecruitTemplates;
                renderRecruitTemplates();
            }
        }

        function renderRecruitTemplates() {
            const grid = document.getElementById('recruitTemplatesGrid');

            grid.innerHTML = recruitTemplates.map(template => `
                <div class="template-card">
                    <div class="template-header">
                        <input type="text"
                               class="template-name"
                               value="${template.name}"
                               id="recruit_name_${template.id}"
                               placeholder="N√°zev ≈°ablony">
                        <div class="template-actions">
                            <button class="btn-save" onclick="saveRecruitTemplate('${template.id}')">üíæ Ulo≈æit</button>
                            <button class="btn-delete" onclick="deleteRecruitTemplate('${template.id}')">üóëÔ∏è Smazat</button>
                        </div>
                    </div>
                    <div class="template-units">
                        ${units.map(unit => `
                            <div class="unit-row">
                                <span class="unit-icon">${unit.icon}</span>
                                <span class="unit-label">${unit.name}</span>
                                <input type="number"
                                       class="unit-input"
                                       value="${template.units[unit.id] || 0}"
                                       id="recruit_${template.id}_${unit.id}"
                                       min="0">
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        async function saveRecruitTemplate(templateId) {
            const name = document.getElementById(`recruit_name_${templateId}`).value;
            const templateUnits = {};

            units.forEach(unit => {
                const input = document.getElementById(`recruit_${templateId}_${unit.id}`);
                if (input) {
                    templateUnits[unit.id] = parseInt(input.value) || 0;
                }
            });

            try {
                const response = await fetch(`/api/templates/recruit/${templateId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, units: templateUnits })
                });

                const result = await response.json();
                if (result.success) {
                    showMessage('‚úÖ ≈†ablona rekrutu ulo≈æena!', 'success');
                    loadRecruitTemplates();
                } else {
                    showMessage('‚ùå Chyba: ' + result.error, 'error');
                }
            } catch (error) {
                showMessage('‚ùå Chyba: ' + error.message, 'error');
            }
        }

        async function deleteRecruitTemplate(templateId) {
            if (!confirm('Opravdu chcete smazat tuto ≈°ablonu?')) return;

            try {
                const response = await fetch(`/api/templates/recruit/${templateId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (result.success) {
                    showMessage('‚úÖ ≈†ablona smaz√°na!', 'success');
                    loadRecruitTemplates();
                } else {
                    showMessage('‚ùå Chyba: ' + result.error, 'error');
                }
            } catch (error) {
                showMessage('‚ùå Chyba: ' + error.message, 'error');
            }
        }

        function addRecruitTemplate() {
            const newId = 'NEW_' + Date.now();
            recruitTemplates.push({
                id: newId,
                name: 'Nov√° ≈°ablona',
                units: {}
            });
            renderRecruitTemplates();
        }

        // ============ V√ùZKUM ============
        async function loadResearchTemplates() {
            const grid = document.getElementById('researchTemplatesGrid');
            grid.innerHTML = '<div class="loading">‚è≥ Naƒç√≠t√°m...</div>';

            try {
                const response = await fetch('/api/templates/research');
                researchTemplates = await response.json();

                if (!researchTemplates || researchTemplates.length === 0) {
                    researchTemplates = defaultResearchTemplates;
                }

                renderResearchTemplates();
            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ ≈°ablon:', error);
                researchTemplates = defaultResearchTemplates;
                renderResearchTemplates();
            }
        }

        function renderResearchTemplates() {
            const grid = document.getElementById('researchTemplatesGrid');

            grid.innerHTML = researchTemplates.map(template => `
                <div class="template-card">
                    <div class="template-header">
                        <input type="text"
                               class="template-name"
                               value="${template.name}"
                               id="research_name_${template.id}"
                               placeholder="N√°zev ≈°ablony">
                        <div class="template-actions">
                            <button class="btn-save" onclick="saveResearchTemplate('${template.id}')">üíæ Ulo≈æit</button>
                            <button class="btn-delete" onclick="deleteResearchTemplate('${template.id}')">üóëÔ∏è Smazat</button>
                        </div>
                    </div>
                    <div class="template-units">
                        ${units.map(unit => `
                            <div class="unit-row">
                                <span class="unit-icon">${unit.icon}</span>
                                <span class="unit-label">${unit.name}</span>
                                <input type="number"
                                       class="unit-input"
                                       value="${template.levels[unit.id] || 0}"
                                       id="research_${template.id}_${unit.id}"
                                       min="0"
                                       max="5"
                                       placeholder="Lvl">
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        async function saveResearchTemplate(templateId) {
            const name = document.getElementById(`research_name_${templateId}`).value;
            const levels = {};

            units.forEach(unit => {
                const input = document.getElementById(`research_${templateId}_${unit.id}`);
                if (input) {
                    levels[unit.id] = parseInt(input.value) || 0;
                }
            });

            try {
                const response = await fetch(`/api/templates/research/${templateId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, levels })
                });

                const result = await response.json();
                if (result.success) {
                    showMessage('‚úÖ ≈†ablona v√Ωzkumu ulo≈æena!', 'success');
                    loadResearchTemplates();
                } else {
                    showMessage('‚ùå Chyba: ' + result.error, 'error');
                }
            } catch (error) {
                showMessage('‚ùå Chyba: ' + error.message, 'error');
            }
        }

        async function deleteResearchTemplate(templateId) {
            if (!confirm('Opravdu chcete smazat tuto ≈°ablonu?')) return;

            try {
                const response = await fetch(`/api/templates/research/${templateId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();
                if (result.success) {
                    showMessage('‚úÖ ≈†ablona smaz√°na!', 'success');
                    loadResearchTemplates();
                } else {
                    showMessage('‚ùå Chyba: ' + result.error, 'error');
                }
            } catch (error) {
                showMessage('‚ùå Chyba: ' + error.message, 'error');
            }
        }

        function addResearchTemplate() {
            const newId = 'NEW_' + Date.now();
            researchTemplates.push({
                id: newId,
                name: 'Nov√° ≈°ablona',
                levels: {}
            });
            renderResearchTemplates();
        }

        // ============ UTILS ============
        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.className = `message message-${type}`;
            messageDiv.textContent = text;

            setTimeout(() => {
                messageDiv.textContent = '';
                messageDiv.className = '';
            }, 5000);
        }

        // Aktualizovat poƒçet √∫ƒçt≈Ø s √∫toky
        async function updateAttackCount() {
            try {
                const response = await fetch('/api/accounts');
                const accounts = await response.json();
                const accountsWithAttacks = accounts.filter(a => a.incoming_attacks > 0).length;
                const attackCountEl = document.getElementById('attackCount');
                if (attackCountEl) {
                    attackCountEl.textContent = accountsWithAttacks > 0 ? `(${accountsWithAttacks})` : '';
                }
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ poƒçtu √∫tok≈Ø:', error);
            }
        }

        // Naƒçten√≠ p≈ôi startu - ≈Ω√ÅDN√ù automatick√Ω update
        loadRecruitTemplates();
        loadResearchTemplates();
        updateAttackCount();
    </script>
</body>
</html>
