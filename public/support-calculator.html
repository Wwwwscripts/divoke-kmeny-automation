<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkul√°tor podpory - Divok√© kmeny</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            padding: 0;
            min-height: 100vh;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #161b22 0%, #1c2128 100%);
            border-bottom: 1px solid #30363d;
            padding: 15px 0;
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1800px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            font-size: 1.5em;
            font-weight: 700;
            background: linear-gradient(135deg, #58a6ff, #79c0ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            white-space: nowrap;
            cursor: pointer;
        }

        .nav {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-left: auto;
        }

        .nav-btn {
            background: #21262d;
            color: #c9d1d9;
            border: 1px solid #30363d;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            white-space: nowrap;
            text-decoration: none;
        }

        .nav-btn:hover {
            background: #30363d;
            border-color: #8b949e;
        }

        /* Zpr√°vy */
        #message {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 6px;
            display: none;
            font-weight: 500;
        }

        #message.success {
            display: block;
            background: #238636;
            color: white;
            border: 1px solid #2ea043;
        }

        #message.error {
            display: block;
            background: #da3633;
            color: white;
            border: 1px solid #f85149;
        }

        #message.info {
            display: block;
            background: #1f6feb;
            color: white;
            border: 1px solid #58a6ff;
        }

        /* Hlavn√≠ sekce */
        h1 {
            font-size: 2em;
            margin-bottom: 10px;
            color: #58a6ff;
        }

        .description {
            color: #8b949e;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        /* Formul√°≈ô */
        .form-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            color: #c9d1d9;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            padding: 10px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #c9d1d9;
            font-size: 14px;
            transition: all 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #58a6ff;
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
        }

        .btn-calculate {
            background: #238636;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 15px;
        }

        .btn-calculate:hover {
            background: #2ea043;
        }

        .btn-calculate:disabled {
            background: #21262d;
            color: #8b949e;
            cursor: not-allowed;
        }

        /* Tabulka v√Ωsledk≈Ø */
        .results-section {
            display: none;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .results-header h2 {
            color: #58a6ff;
            font-size: 1.5em;
        }

        .btn-send-all {
            background: #1f6feb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 14px;
        }

        .btn-send-all:hover {
            background: #58a6ff;
        }

        .results-table {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #21262d;
        }

        th {
            padding: 15px;
            text-align: left;
            color: #8b949e;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tbody tr {
            border-top: 1px solid #30363d;
            transition: background 0.2s;
        }

        tbody tr:hover {
            background: #21262d;
        }

        tbody tr.no-units {
            background: #2d1e1e;
        }

        td {
            padding: 15px;
            color: #c9d1d9;
        }

        /* Ikony jednotek */
        .unit-icon {
            width: 24px;
            height: 24px;
            vertical-align: middle;
            margin-right: 5px;
        }

        .unit-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Tlaƒç√≠tka akce */
        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .action-btn {
            background: #21262d;
            color: #c9d1d9;
            border: 1px solid #30363d;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            text-decoration: none;
            white-space: nowrap;
        }

        .action-btn:hover {
            background: #30363d;
        }

        .action-btn.auto {
            background: #1f6feb;
            border-color: #1f6feb;
            color: white;
        }

        .action-btn.auto:hover {
            background: #58a6ff;
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #238636;
            color: white;
        }

        .badge-warning {
            background: #9e6a03;
            color: white;
        }

        .badge-danger {
            background: #da3633;
            color: white;
        }

        /* Pr√°zdn√Ω stav */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #8b949e;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .empty-state-text {
            font-size: 1.2em;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="logo" onclick="window.location.href='/'">üè∞ Divok√© kmeny</div>
            <div class="nav">
                <a href="/" class="nav-btn">üè† Dom≈Ø</a>
                <a href="/units.html" class="nav-btn">‚öîÔ∏è Jednotky</a>
                <a href="/world-settings.html" class="nav-btn">üåç Nastaven√≠ svƒõt≈Ø</a>
            </div>
        </div>
    </div>

    <div class="container">
        <h1>üõ°Ô∏è Kalkul√°tor podpory</h1>
        <p class="description">Vypoƒç√≠tejte, kter√© vesnice a jednotky stihnou dorazit na zadan√© sou≈ôadnice v po≈æadovan√©m ƒçase.</p>

        <div id="message"></div>

        <!-- Formul√°≈ô -->
        <div class="form-card">
            <div class="form-row">
                <div class="form-group">
                    <label for="world-select">Svƒõt</label>
                    <select id="world-select">
                        <option value="">Vyberte svƒõt...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="target-coords">C√≠lov√© sou≈ôadnice (X|Y)</label>
                    <input type="text" id="target-coords" placeholder="nap≈ô. 500|500">
                </div>

                <div class="form-group">
                    <label for="arrival-time">ƒåas dopadu</label>
                    <input type="datetime-local" id="arrival-time">
                </div>

                <div class="form-group">
                    <label for="support-boost">Zrychlen√≠ podpor (%)</label>
                    <input type="number" id="support-boost" placeholder="nap≈ô. 50" min="0" max="100" step="1" value="0">
                </div>
            </div>

            <button class="btn-calculate" onclick="calculateSupport()">üîç Vypoƒç√≠tat podporu</button>
        </div>

        <!-- V√Ωsledky -->
        <div id="results-section" class="results-section">
            <div class="results-header">
                <h2>üìä Dostupn√© mo≈ænosti podpory</h2>
                <button class="btn-send-all" onclick="sendAllSupport()">üöÄ Odeslat v≈°e automaticky</button>
            </div>

            <div class="results-table">
                <table>
                    <thead>
                        <tr>
                            <th>Vesnice</th>
                            <th>Sou≈ôadnice</th>
                            <th>Vzd√°lenost</th>
                            <th>Nejrychlej≈°√≠ jednotka</th>
                            <th>ƒåas odesl√°n√≠</th>
                            <th>Doraz√≠</th>
                            <th>Akce</th>
                        </tr>
                    </thead>
                    <tbody id="results-tbody">
                        <!-- Naƒçteno z v√Ωpoƒçtu -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Konstanty rychlost√≠ jednotek (minuty/pole)
        const UNIT_SPEEDS = {
            knight: 10,   // Paladin
            spy: 9,
            light: 10,
            marcher: 10,
            heavy: 11,
            spear: 18,
            sword: 22,
            axe: 18,
            archer: 18,
            ram: 30,
            catapult: 30,
            snob: 35
        };

        // N√°zvy jednotek ƒçesky
        const UNIT_NAMES = {
            knight: 'Paladin',
            spy: 'Zvƒõd',
            light: 'Lehk√° j√≠zda',
            marcher: 'Lukost≈ôelec na koni',
            heavy: 'Tƒõ≈æk√° j√≠zda',
            spear: 'Kop√≠',
            sword: 'Meƒç',
            axe: 'Sekera',
            archer: 'Lukost≈ôelec',
            ram: 'Beran',
            catapult: 'Katapult',
            snob: '≈†lechtic'
        };

        // Po≈ôad√≠ jednotek (od nejrychlej≈°√≠)
        const UNIT_ORDER = ['spy', 'knight', 'light', 'marcher', 'heavy', 'spear', 'axe', 'archer', 'sword', 'ram', 'catapult', 'snob'];

        let calculationResults = [];

        // Naƒç√≠st svƒõty p≈ôi naƒçten√≠ str√°nky
        window.addEventListener('DOMContentLoaded', async () => {
            await loadWorlds();
            setDefaultArrivalTime();
        });

        async function loadWorlds() {
            try {
                const response = await fetch('/api/accounts');
                const accounts = await response.json();

                // Z√≠skat unik√°tn√≠ svƒõty
                const worlds = [...new Set(accounts.map(acc => acc.world).filter(w => w))];

                const select = document.getElementById('world-select');
                select.innerHTML = '<option value="">Vyberte svƒõt...</option>' +
                    worlds.map(world => `<option value="${world}">${world}</option>`).join('');

            } catch (error) {
                showMessage('Chyba p≈ôi naƒç√≠t√°n√≠ svƒõt≈Ø: ' + error.message, 'error');
            }
        }

        function setDefaultArrivalTime() {
            const now = new Date();
            now.setHours(now.getHours() + 1);
            const timeString = now.toISOString().slice(0, 16);
            document.getElementById('arrival-time').value = timeString;
        }

        async function calculateSupport() {
            const world = document.getElementById('world-select').value;
            const coords = document.getElementById('target-coords').value;
            const arrivalTime = document.getElementById('arrival-time').value;
            const supportBoost = parseFloat(document.getElementById('support-boost').value) || 0;

            // Validace
            if (!world) {
                showMessage('Vyberte svƒõt', 'error');
                return;
            }

            if (!coords || !coords.match(/^\d+\|\d+$/)) {
                showMessage('Zadejte platn√© sou≈ôadnice ve form√°tu X|Y', 'error');
                return;
            }

            if (!arrivalTime) {
                showMessage('Zadejte ƒças dopadu', 'error');
                return;
            }

            if (supportBoost < 0 || supportBoost > 100) {
                showMessage('Zrychlen√≠ mus√≠ b√Ωt mezi 0 a 100 %', 'error');
                return;
            }

            const [targetX, targetY] = coords.split('|').map(Number);
            const arrivalDate = new Date(arrivalTime);
            const now = new Date();

            if (arrivalDate <= now) {
                showMessage('ƒåas dopadu mus√≠ b√Ωt v budoucnosti', 'error');
                return;
            }

            try {
                showMessage('Poƒç√≠t√°m mo≈ænosti podpory...', 'info');

                // Z√≠skat nastaven√≠ svƒõta
                const worldSettingsRes = await fetch(`/api/world-settings/${world}`);
                const worldSettings = await worldSettingsRes.json();
                const worldSpeed = worldSettings.speed || 1;

                // Z√≠skat √∫ƒçty na dan√©m svƒõtƒõ
                const accountsRes = await fetch('/api/accounts');
                const accounts = await accountsRes.json();
                const worldAccounts = accounts.filter(acc => acc.world === world && acc.coord_x && acc.coord_y);

                if (worldAccounts.length === 0) {
                    showMessage('≈Ω√°dn√© vesnice na svƒõtƒõ ' + world, 'error');
                    return;
                }

                // Vypoƒç√≠tat pro ka≈ædou vesnici
                calculationResults = [];
                for (const account of worldAccounts) {
                    const distance = calculateDistance(account.coord_x, account.coord_y, targetX, targetY);
                    const availableTime = (arrivalDate - now) / 1000 / 60; // minuty

                    // Naj√≠t nejrychlej≈°√≠ dostupnou jednotku
                    let fastestUnit = null;
                    let travelTime = null;

                    // Parsovat units_info
                    let unitsInfo = {};
                    if (account.units_info) {
                        try {
                            unitsInfo = JSON.parse(account.units_info);
                        } catch (e) {
                            console.error('Chyba p≈ôi parsov√°n√≠ units_info:', e);
                        }
                    }

                    for (const unit of UNIT_ORDER) {
                        const unitSpeed = UNIT_SPEEDS[unit];
                        const boostMultiplier = 1 + (supportBoost / 100);
                        const requiredTime = (distance * unitSpeed) / (worldSpeed * boostMultiplier);

                        // Zkontrolovat, jestli jednotka stihne a jestli ji m√°me
                        const unitCount = unitsInfo[unit]?.inVillages || 0;

                        if (requiredTime <= availableTime && unitCount > 0) {
                            fastestUnit = unit;
                            travelTime = requiredTime;
                            break;
                        }
                    }

                    calculationResults.push({
                        account,
                        distance,
                        fastestUnit,
                        travelTime,
                        sendTime: fastestUnit ? new Date(arrivalDate - travelTime * 60 * 1000) : null,
                        arrivalTime: arrivalDate,
                        targetX,
                        targetY,
                        worldSpeed
                    });
                }

                displayResults();
                showMessage(`Nalezeno ${calculationResults.length} vesnic`, 'success');

            } catch (error) {
                showMessage('Chyba p≈ôi v√Ωpoƒçtu: ' + error.message, 'error');
            }
        }

        function calculateDistance(x1, y1, x2, y2) {
            return Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
        }

        function displayResults() {
            const tbody = document.getElementById('results-tbody');
            const resultsSection = document.getElementById('results-section');

            if (calculationResults.length === 0) {
                resultsSection.style.display = 'none';
                return;
            }

            resultsSection.style.display = 'block';

            // Se≈ôadit podle vzd√°lenosti
            calculationResults.sort((a, b) => a.distance - b.distance);

            tbody.innerHTML = calculationResults.map(result => {
                const account = result.account;
                const hasUnits = result.fastestUnit !== null;
                const rowClass = hasUnits ? '' : 'no-units';

                let unitDisplay = '';
                let sendTimeDisplay = '';
                let statusBadge = '';
                let actions = '';

                if (hasUnits) {
                    unitDisplay = `
                        <div class="unit-info">
                            <img src="/images/unit_${result.fastestUnit}.png" class="unit-icon" alt="${result.fastestUnit}">
                            <span>${UNIT_NAMES[result.fastestUnit]}</span>
                        </div>
                    `;
                    sendTimeDisplay = formatDateTime(result.sendTime);
                    statusBadge = '<span class="badge badge-success">Stihne</span>';

                    const domain = account.world.startsWith('sk') ? 'divoke-kmene.sk' : 'divokekmeny.cz';
                    const manualUrl = `https://${account.world}.${domain}/game.php?village=${account.village_id}&screen=place&target=${result.targetX}|${result.targetY}`;

                    actions = `
                        <div class="action-buttons">
                            <a href="${manualUrl}" target="_blank" class="action-btn">üìù Ruƒçnƒõ</a>
                            <button class="action-btn auto" onclick="sendSupport(${account.id}, '${result.fastestUnit}', ${result.targetX}, ${result.targetY})">‚ö° Auto</button>
                        </div>
                    `;
                } else {
                    unitDisplay = '<span style="color: #8b949e;">≈Ω√°dn√© dostupn√© jednotky</span>';
                    sendTimeDisplay = '-';
                    statusBadge = '<span class="badge badge-danger">Nestihne</span>';
                    actions = '-';
                }

                return `
                    <tr class="${rowClass}">
                        <td><strong>${account.village_name || account.username}</strong></td>
                        <td>${account.coord_x}|${account.coord_y}</td>
                        <td>${result.distance.toFixed(2)} pol√≠</td>
                        <td>${unitDisplay}</td>
                        <td>${sendTimeDisplay}</td>
                        <td>${statusBadge}</td>
                        <td>${actions}</td>
                    </tr>
                `;
            }).join('');
        }

        function formatDateTime(date) {
            if (!date) return '-';
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${day}.${month}.${year} ${hours}:${minutes}:${seconds}`;
        }

        async function sendSupport(accountId, unitType, targetX, targetY) {
            try {
                showMessage('Odes√≠l√°m podporu...', 'info');

                const response = await fetch('/api/support/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        accountId,
                        unitType,
                        targetX,
                        targetY
                    })
                });

                if (response.ok) {
                    showMessage('Podpora odesl√°na!', 'success');
                } else {
                    const error = await response.json();
                    showMessage('Chyba: ' + error.error, 'error');
                }
            } catch (error) {
                showMessage('Chyba p≈ôi odes√≠l√°n√≠: ' + error.message, 'error');
            }
        }

        async function sendAllSupport() {
            const supportToSend = calculationResults.filter(r => r.fastestUnit !== null);

            if (supportToSend.length === 0) {
                showMessage('≈Ω√°dn√© podpory k odesl√°n√≠', 'error');
                return;
            }

            if (!confirm(`Opravdu chcete odeslat ${supportToSend.length} podpor?`)) {
                return;
            }

            showMessage(`Odes√≠l√°m ${supportToSend.length} podpor...`, 'info');

            let successCount = 0;
            let errorCount = 0;

            for (const result of supportToSend) {
                try {
                    const response = await fetch('/api/support/send', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            accountId: result.account.id,
                            unitType: result.fastestUnit,
                            targetX: result.targetX,
                            targetY: result.targetY
                        })
                    });

                    if (response.ok) {
                        successCount++;
                    } else {
                        errorCount++;
                    }
                } catch (error) {
                    errorCount++;
                }
            }

            showMessage(`Odesl√°no: ${successCount} √∫spƒõ≈°nƒõ, ${errorCount} s chybou`, successCount > 0 ? 'success' : 'error');
        }

        function showMessage(text, type) {
            const message = document.getElementById('message');
            message.textContent = text;
            message.className = type;
            if (type !== 'info') {
                setTimeout(() => {
                    message.style.display = 'none';
                }, 5000);
            }
        }
    </script>
</body>
</html>
