<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkul√°tor podpory - Divok√© kmeny</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            padding: 0;
            min-height: 100vh;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #161b22 0%, #1c2128 100%);
            border-bottom: 1px solid #30363d;
            padding: 15px 0;
            margin-bottom: 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1800px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            font-size: 1.5em;
            font-weight: 700;
            background: linear-gradient(135deg, #58a6ff, #79c0ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            white-space: nowrap;
            cursor: pointer;
        }

        .nav {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-left: auto;
        }

        .nav-btn {
            background: #21262d;
            color: #c9d1d9;
            border: 1px solid #30363d;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
            white-space: nowrap;
            text-decoration: none;
        }

        .nav-btn:hover {
            background: #30363d;
            border-color: #8b949e;
        }

        /* Zpr√°vy */
        #message {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 6px;
            display: none;
            font-weight: 500;
        }

        #message.success {
            display: block;
            background: #238636;
            color: white;
            border: 1px solid #2ea043;
        }

        #message.error {
            display: block;
            background: #da3633;
            color: white;
            border: 1px solid #f85149;
        }

        #message.info {
            display: block;
            background: #1f6feb;
            color: white;
            border: 1px solid #58a6ff;
        }

        /* Hlavn√≠ sekce */
        h1 {
            font-size: 2em;
            margin-bottom: 10px;
            color: #58a6ff;
        }

        .description {
            color: #8b949e;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        /* Formul√°≈ô */
        .form-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            margin-bottom: 8px;
            color: #c9d1d9;
            font-weight: 500;
        }

        .form-group input,
        .form-group select {
            padding: 10px;
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #c9d1d9;
            font-size: 14px;
            transition: all 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #58a6ff;
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
        }

        .btn-calculate {
            background: #238636;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 15px;
        }

        .btn-calculate:hover {
            background: #2ea043;
        }

        .btn-calculate:disabled {
            background: #21262d;
            color: #8b949e;
            cursor: not-allowed;
        }

        /* Tabulka v√Ωsledk≈Ø */
        .results-section {
            display: none;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .results-header h2 {
            color: #58a6ff;
            font-size: 1.5em;
        }

        .btn-send-all {
            background: #1f6feb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 14px;
        }

        .btn-send-all:hover {
            background: #58a6ff;
        }

        .results-table {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 8px;
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #21262d;
        }

        th {
            padding: 15px;
            text-align: left;
            color: #8b949e;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tbody tr {
            border-top: 1px solid #30363d;
            transition: background 0.2s;
        }

        tbody tr:hover {
            background: #21262d;
        }

        tbody tr.no-units {
            background: #2d1e1e;
        }

        td {
            padding: 15px;
            color: #c9d1d9;
        }

        /* Ikony jednotek */
        .unit-icon {
            width: 24px;
            height: 24px;
            vertical-align: middle;
            margin-right: 5px;
        }

        .unit-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Tlaƒç√≠tka akce */
        .action-buttons {
            display: flex;
            gap: 5px;
        }

        .action-btn {
            background: #21262d;
            color: #c9d1d9;
            border: 1px solid #30363d;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            text-decoration: none;
            white-space: nowrap;
        }

        .action-btn:hover {
            background: #30363d;
        }

        .action-btn.auto {
            background: #1f6feb;
            border-color: #1f6feb;
            color: white;
        }

        .action-btn.auto:hover {
            background: #58a6ff;
        }

        /* Badge */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-success {
            background: #238636;
            color: white;
        }

        .badge-warning {
            background: #9e6a03;
            color: white;
        }

        .badge-danger {
            background: #da3633;
            color: white;
        }

        .badge-info {
            background: #1f6feb;
            color: white;
        }

        .badge-sent {
            background: #2da44e;
            color: white;
        }

        /* Pr√°zdn√Ω stav */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #8b949e;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        .empty-state-text {
            font-size: 1.2em;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="logo" onclick="window.location.href='/'">üè∞ Divok√© kmeny</div>
            <div class="nav">
                <button class="nav-btn" onclick="window.location.href='/index.html'">üè† Dashboard</button>
                <button class="nav-btn danger" onclick="window.location.href='/attacks.html'">üö® √ötoky <span id="attackCount"></span></button>
                <button class="nav-btn" onclick="window.location.href='/units.html'">‚öîÔ∏è Jednotky</button>
                <button class="nav-btn" onclick="window.location.href='/units-away.html'">üìç Mimo vesnici</button>
                <button class="nav-btn" onclick="window.location.href='/support-calculator.html'">üõ°Ô∏è Kalkul√°tor</button>
                <button class="nav-btn" onclick="loadUnits()">üîÑ</button>
                <div class="dropdown" id="moreMenu">
                    <button class="nav-btn" onclick="toggleDropdown()">‚ãØ</button>
                    <div class="dropdown-content">
                        <div class="dropdown-item" onclick="window.location.href='/accounts.html'">‚ûï P≈ôidat √∫ƒçet</div>
                        <div class="dropdown-item" onclick="window.location.href='/training-templates.html'">üìã ≈†ablony</div>
                        <div class="dropdown-item" onclick="window.location.href='/world-settings.html'">üåç Nastaven√≠ svƒõt≈Ø</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <h1>üõ°Ô∏è Kalkul√°tor podpory</h1>
        <p class="description">Vypoƒç√≠tejte, kter√© vesnice a jednotky stihnou dorazit na zadan√© sou≈ôadnice v po≈æadovan√©m ƒçase.</p>

        <div id="message"></div>

        <!-- Formul√°≈ô -->
        <div class="form-card">
            <div class="form-row">
                <div class="form-group">
                    <label for="world-select">Svƒõt</label>
                    <select id="world-select" onchange="loadTribes()">
                        <option value="">Vyberte svƒõt...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="tribe-select">Kmen</label>
                    <select id="tribe-select">
                        <option value="">Nejprve vyberte svƒõt...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="target-coords">C√≠lov√© sou≈ôadnice (X|Y)</label>
                    <input type="text" id="target-coords" placeholder="nap≈ô. 500|500">
                </div>

                <div class="form-group">
                    <label for="arrival-time">ƒåas dopadu</label>
                    <input type="datetime-local" id="arrival-time">
                </div>

                <div class="form-group">
                    <label for="support-boost">Zrychlen√≠ podpor (%)</label>
                    <input type="number" id="support-boost" placeholder="nap≈ô. 50" min="0" max="100" step="1" value="0">
                </div>
            </div>

            <div class="form-group" style="margin-top: 10px;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="spy-only" style="margin-right: 8px; width: auto;">
                    <span>Pouze ≈°pehov√© (pos√≠lat jen ≈°pehy na podporu)</span>
                </label>
            </div>

            <button class="btn-calculate" onclick="calculateSupport()">üîç Vypoƒç√≠tat podporu</button>
        </div>

        <!-- V√Ωsledky -->
        <div id="results-section" class="results-section">
            <div class="results-header">
                <h2>üìä Dostupn√© mo≈ænosti podpory</h2>
                <button class="btn-send-all" onclick="sendAllSupport()">üöÄ Odeslat v≈°e automaticky</button>
            </div>

            <div class="results-table">
                <table>
                    <thead>
                        <tr>
                            <th>Vesnice</th>
                            <th>Sou≈ôadnice</th>
                            <th>Vzd√°lenost</th>
                            <th>Nejrychlej≈°√≠ jednotka</th>
                            <th>ƒåas cesty</th>
                            <th>ƒåas odesl√°n√≠</th>
                            <th>Doraz√≠</th>
                            <th>Akce</th>
                        </tr>
                    </thead>
                    <tbody id="results-tbody">
                        <!-- Naƒçteno z v√Ωpoƒçtu -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Konstanty rychlost√≠ jednotek (minuty/pole)
        const UNIT_SPEEDS = {
            knight: 10,   // Paladin
            spy: 9,
            light: 10,
            marcher: 10,
            heavy: 11,
            spear: 18,
            sword: 22,
            axe: 18,
            archer: 18,
            ram: 30,
            catapult: 30,
            snob: 35
        };

        // N√°zvy jednotek ƒçesky
        const UNIT_NAMES = {
            knight: 'Paladin',
            spy: 'Zvƒõd',
            light: 'Lehk√° j√≠zda',
            marcher: 'Lukost≈ôelec na koni',
            heavy: 'Tƒõ≈æk√° j√≠zda',
            spear: 'Kop√≠',
            sword: 'Meƒç',
            axe: 'Sekera',
            archer: 'Lukost≈ôelec',
            ram: 'Beran',
            catapult: 'Katapult',
            snob: '≈†lechtic'
        };

        // Po≈ôad√≠ jednotek (od nejrychlej≈°√≠)
        const UNIT_ORDER = ['spy', 'knight', 'light', 'marcher', 'heavy', 'spear', 'axe', 'archer', 'sword', 'ram', 'catapult', 'snob'];
        const UNIT_ORDER_NO_SPY = ['knight', 'light', 'marcher', 'heavy', 'spear', 'axe', 'archer', 'sword', 'ram', 'catapult', 'snob'];

        let calculationResults = [];
        let allAccounts = []; // V≈°echny √∫ƒçty pro filtrov√°n√≠ podle svƒõta a kmene

        // Naƒç√≠st svƒõty p≈ôi naƒçten√≠ str√°nky
        window.addEventListener('DOMContentLoaded', async () => {
            await loadWorlds();
            setDefaultArrivalTime();
            loadPreferences();
        });

        // Naƒç√≠st ulo≈æen√© preference
        function loadPreferences() {
            const savedWorld = localStorage.getItem('support_calc_world');
            const savedTribe = localStorage.getItem('support_calc_tribe');

            if (savedWorld) {
                document.getElementById('world-select').value = savedWorld;
                loadTribes(); // Naƒçti kmeny pro ulo≈æen√Ω svƒõt

                // Po naƒçten√≠ kmen≈Ø nastav ulo≈æen√Ω kmen
                setTimeout(() => {
                    if (savedTribe) {
                        document.getElementById('tribe-select').value = savedTribe;
                    }
                }, 100);
            }
        }

        // Ulo≈æit preference
        function savePreferences() {
            const world = document.getElementById('world-select').value;
            const tribe = document.getElementById('tribe-select').value;

            if (world) localStorage.setItem('support_calc_world', world);
            if (tribe) localStorage.setItem('support_calc_tribe', tribe);
        }

        async function loadWorlds() {
            try {
                const response = await fetch('/api/accounts');
                allAccounts = await response.json();

                // Z√≠skat unik√°tn√≠ svƒõty
                const worlds = [...new Set(allAccounts.map(acc => acc.world).filter(w => w))];

                const select = document.getElementById('world-select');
                select.innerHTML = '<option value="">Vyberte svƒõt...</option>' +
                    worlds.map(world => `<option value="${world}">${world}</option>`).join('');

            } catch (error) {
                showMessage('Chyba p≈ôi naƒç√≠t√°n√≠ svƒõt≈Ø: ' + error.message, 'error');
            }
        }

        // Naƒç√≠st kmeny pro vybran√Ω svƒõt
        function loadTribes() {
            const world = document.getElementById('world-select').value;
            const tribeSelect = document.getElementById('tribe-select');

            if (!world) {
                tribeSelect.innerHTML = '<option value="">Nejprve vyberte svƒõt...</option>';
                return;
            }

            // Filtrovat √∫ƒçty podle svƒõta
            const worldAccounts = allAccounts.filter(acc => acc.world === world);

            // Z√≠skat unik√°tn√≠ kmeny (tribe_name)
            const tribes = [...new Set(worldAccounts.map(acc => acc.tribe_name).filter(t => t))];
            tribes.sort(); // Se≈ôadit abecednƒõ

            tribeSelect.innerHTML = '<option value="">V≈°e (v≈°echny kmeny)</option>' +
                tribes.map(tribe => `<option value="${tribe}">${tribe}</option>`).join('');

            // Ulo≈æit preferenci
            savePreferences();
        }

        function setDefaultArrivalTime() {
            const now = new Date();
            now.setHours(now.getHours() + 1);
            const timeString = now.toISOString().slice(0, 16);
            document.getElementById('arrival-time').value = timeString;
        }

        async function calculateSupport() {
            const world = document.getElementById('world-select').value;
            const tribe = document.getElementById('tribe-select').value;
            const coords = document.getElementById('target-coords').value;
            const arrivalTime = document.getElementById('arrival-time').value;
            const supportBoost = parseFloat(document.getElementById('support-boost').value) || 0;
            const spyOnly = document.getElementById('spy-only').checked;

            // Validace
            if (!world) {
                showMessage('Vyberte svƒõt', 'error');
                return;
            }

            if (!coords || !coords.match(/^\d+\|\d+$/)) {
                showMessage('Zadejte platn√© sou≈ôadnice ve form√°tu X|Y', 'error');
                return;
            }

            if (!arrivalTime) {
                showMessage('Zadejte ƒças dopadu', 'error');
                return;
            }

            if (supportBoost < 0 || supportBoost > 100) {
                showMessage('Zrychlen√≠ mus√≠ b√Ωt mezi 0 a 100 %', 'error');
                return;
            }

            const [targetX, targetY] = coords.split('|').map(Number);
            const arrivalDate = new Date(arrivalTime);
            const now = new Date();

            if (arrivalDate <= now) {
                showMessage('ƒåas dopadu mus√≠ b√Ωt v budoucnosti', 'error');
                return;
            }

            try {
                // Z√≠skat nastaven√≠ svƒõta
                const worldSettingsRes = await fetch(`/api/world-settings/${world}`);
                const worldSettings = await worldSettingsRes.json();
                const worldSpeed = worldSettings.speed || 1;
                const unitSpeedModifier = worldSettings.unitSpeedModifier || 1;

                // Z√≠skat √∫ƒçty na dan√©m svƒõtƒõ
                const accountsRes = await fetch('/api/accounts');
                const accounts = await accountsRes.json();

                // Filtrovat podle svƒõta, kmene a stavu paused
                let worldAccounts = accounts.filter(acc =>
                    acc.world === world &&
                    acc.coord_x &&
                    acc.coord_y &&
                    !acc.paused  // Vyfiltrovat paused √∫ƒçty
                );

                // Pokud je vybr√°n konkr√©tn√≠ kmen, filtruj podle nƒõj
                if (tribe) {
                    worldAccounts = worldAccounts.filter(acc => acc.tribe_name === tribe);
                }

                // Ulo≈æit preferenci
                savePreferences();

                if (worldAccounts.length === 0) {
                    const tribePart = tribe ? ` v kmeni ${tribe}` : '';
                    showMessage(`≈Ω√°dn√© aktivn√≠ vesnice na svƒõtƒõ ${world}${tribePart}`, 'error');
                    return;
                }

                // KROK 1: Nejd≈ô√≠ve kontrola jednotek
                showMessage(`Kontroluji jednotky na ${worldAccounts.length} √∫ƒçtech...`, 'info');

                const accountIds = worldAccounts.map(acc => acc.id);
                const refreshRes = await fetch('/api/units/refresh', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ accountIds })
                });

                if (!refreshRes.ok) {
                    showMessage('Chyba p≈ôi kontrole jednotek', 'error');
                    return;
                }

                const refreshData = await refreshRes.json();
                console.log(`‚úÖ Kontrola jednotek dokonƒçena: ${refreshData.results.success}/${refreshData.results.total} √∫spƒõ≈°n√Ωch`);

                // KROK 2: Z√≠skat aktualizovan√© √∫daje o √∫ƒçtech
                showMessage('Poƒç√≠t√°m mo≈ænosti podpory...', 'info');
                const updatedAccountsRes = await fetch('/api/accounts');
                const updatedAccounts = await updatedAccountsRes.json();

                // Znovu filtrovat - tentokr√°t s aktu√°ln√≠mi daty
                worldAccounts = updatedAccounts.filter(acc =>
                    acc.world === world &&
                    acc.coord_x &&
                    acc.coord_y &&
                    !acc.paused
                );

                if (tribe) {
                    worldAccounts = worldAccounts.filter(acc => acc.tribe_name === tribe);
                }

                // Vypoƒç√≠tat pro ka≈ædou vesnici
                calculationResults = [];
                for (const account of worldAccounts) {
                    const distance = calculateDistance(account.coord_x, account.coord_y, targetX, targetY);
                    const availableTime = (arrivalDate - now) / 1000 / 60; // minuty

                    // Naj√≠t nejrychlej≈°√≠ dostupnou jednotku
                    let fastestUnit = null;
                    let travelTime = null;
                    let unitsToSend = [];

                    // Parsovat units_info
                    let unitsInfo = {};
                    if (account.units_info) {
                        try {
                            unitsInfo = JSON.parse(account.units_info);
                        } catch (e) {
                            console.error('Chyba p≈ôi parsov√°n√≠ units_info:', e);
                        }
                    }

                    // Pokud pouze ≈°pehov√©
                    if (spyOnly) {
                        const unitSpeed = UNIT_SPEEDS['spy'];
                        const boostMultiplier = 1 + (supportBoost / 100);
                        const requiredTime = (distance * unitSpeed) / (worldSpeed * boostMultiplier * unitSpeedModifier);
                        const unitCount = unitsInfo['spy']?.inVillages || 0;

                        if (requiredTime <= availableTime && unitCount > 0) {
                            fastestUnit = 'spy';
                            travelTime = requiredTime;
                            unitsToSend = ['spy'];
                        }
                    } else {
                        // Bƒõ≈æn√° podpora (bez ≈°peh≈Ø)
                        for (const unit of UNIT_ORDER_NO_SPY) {
                            const unitSpeed = UNIT_SPEEDS[unit];
                            const boostMultiplier = 1 + (supportBoost / 100);
                            const requiredTime = (distance * unitSpeed) / (worldSpeed * boostMultiplier * unitSpeedModifier);
                            const unitCount = unitsInfo[unit]?.inVillages || 0;

                            if (requiredTime <= availableTime && unitCount > 0) {
                                fastestUnit = unit;

                                // Naj√≠t v≈°echny jednotky, kter√© maj√≠ stejnou nebo pomalej≈°√≠ rychlost ne≈æ nejrychlej≈°√≠
                                const fastestSpeed = UNIT_SPEEDS[unit];
                                unitsToSend = UNIT_ORDER_NO_SPY.filter(u => {
                                    const speed = UNIT_SPEEDS[u];
                                    const count = unitsInfo[u]?.inVillages || 0;
                                    return speed >= fastestSpeed && count > 0;
                                });

                                // Spoƒç√≠tat cestovn√≠ ƒças:
                                // - Pokud jde paladin, V≈†ECHNY jednotky jedou rychlost√≠ paladina (10)
                                // - Jinak jedou rychlost√≠ nejpomalej≈°√≠ jednotky
                                let effectiveSpeed;
                                if (unitsToSend.includes('knight')) {
                                    effectiveSpeed = UNIT_SPEEDS['knight']; // Paladin urƒçuje rychlost
                                } else {
                                    effectiveSpeed = Math.max(...unitsToSend.map(u => UNIT_SPEEDS[u])); // Nejpomalej≈°√≠ jednotka
                                }

                                const boostMultiplier = 1 + (supportBoost / 100);
                                travelTime = (distance * effectiveSpeed) / (worldSpeed * boostMultiplier * unitSpeedModifier);

                                break;
                            }
                        }
                    }

                    calculationResults.push({
                        account,
                        distance,
                        fastestUnit,
                        unitsToSend,
                        travelTime,
                        sendTime: fastestUnit ? new Date(arrivalDate - travelTime * 60 * 1000) : null,
                        arrivalTime: arrivalDate,
                        targetX,
                        targetY,
                        worldSpeed
                    });
                }

                displayResults();
                showMessage(`Nalezeno ${calculationResults.length} vesnic`, 'success');

            } catch (error) {
                showMessage('Chyba p≈ôi v√Ωpoƒçtu: ' + error.message, 'error');
            }
        }

        function calculateDistance(x1, y1, x2, y2) {
            return Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
        }

        function formatTravelTime(minutes) {
            if (!minutes) return '-';
            const hours = Math.floor(minutes / 60);
            const mins = Math.floor(minutes % 60);
            const secs = Math.floor((minutes % 1) * 60);
            return `${hours}:${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function displayResults() {
            const tbody = document.getElementById('results-tbody');
            const resultsSection = document.getElementById('results-section');

            if (calculationResults.length === 0) {
                resultsSection.style.display = 'none';
                return;
            }

            resultsSection.style.display = 'block';

            // Filtrovat pouze √∫ƒçty kter√© ST√çHAJ√ç a MAJ√ç jednotky
            const validResults = calculationResults.filter(r => r.fastestUnit !== null);

            if (validResults.length === 0) {
                showMessage('≈Ω√°dn√© vesnice nestihnou odeslat podporu', 'error');
                resultsSection.style.display = 'none';
                return;
            }

            // Se≈ôadit podle vzd√°lenosti
            validResults.sort((a, b) => a.distance - b.distance);

            const canSendCount = validResults.length;
            const totalChecked = calculationResults.length;

            // Spoƒç√≠tat celkov√Ω poƒçet jednotek (pouze z validResults)
            const totalUnits = {};
            const unitsPerAccount = [];

            validResults.forEach(result => {
                if (result.fastestUnit !== null && result.unitsToSend) {
                    const accountUnits = { account: result.account.username, units: {} };

                    result.unitsToSend.forEach(unit => {
                        // Z√≠skat poƒçet jednotek pro dan√Ω typ z account.units_info
                        const account = result.account;
                        if (account.units_info) {
                            try {
                                const unitsInfo = JSON.parse(account.units_info);
                                const count = unitsInfo[unit]?.inVillages || 0;
                                if (count > 0) {
                                    totalUnits[unit] = (totalUnits[unit] || 0) + count;
                                    accountUnits.units[unit] = count;
                                }
                            } catch (e) {
                                console.error('Chyba p≈ôi parsov√°n√≠ units_info:', e);
                            }
                        }
                    });

                    if (Object.keys(accountUnits.units).length > 0) {
                        unitsPerAccount.push(accountUnits);
                    }
                }
            });

            // Vypsat jednotky do konzole (ZLEP≈†EN√ù LOG)
            console.log('\n=== üõ°Ô∏è NALEZEN√â JEDNOTKY ===');
            unitsPerAccount.forEach(({ account, units }) => {
                const unitsText = Object.entries(units)
                    .map(([unit, count]) => `${UNIT_NAMES[unit]}: ${count}`)
                    .join(', ');
                console.log(`   ${account}: ${unitsText}`);
            });
            console.log('=========================\n');

            // Vytvo≈ôit text s celkov√Ωm poƒçtem jednotek
            let totalUnitsText = '';
            if (Object.keys(totalUnits).length > 0) {
                const unitCounts = Object.entries(totalUnits)
                    .map(([unit, count]) => `${UNIT_NAMES[unit]}: ${count}`)
                    .join(', ');
                totalUnitsText = ` | Celkem jednotek: ${unitCounts}`;
            }

            tbody.innerHTML = validResults.map((result, index) => {
                const account = result.account;

                // Zobrazit v≈°echny jednotky, kter√© se po≈°lou vƒçetnƒõ poƒçtu
                const unitsInfo = account.units_info ? JSON.parse(account.units_info) : {};
                const unitsDisplay = result.unitsToSend.map(unit => {
                    const count = unitsInfo[unit]?.inVillages || 0;
                    return `
                        <div style="display: inline-flex; align-items: center; margin-right: 10px;">
                            <img src="/images/unit_${unit}.png" class="unit-icon" alt="${UNIT_NAMES[unit]}" title="${UNIT_NAMES[unit]}">
                            <span style="margin-left: 4px; font-weight: 600;">${count}</span>
                        </div>
                    `;
                }).join('');

                const unitDisplay = `
                    <div class="unit-info">
                        ${unitsDisplay}
                    </div>
                `;
                const travelTimeDisplay = formatTravelTime(result.travelTime);
                const sendTimeDisplay = formatDateTime(result.sendTime);
                const statusBadge = `<span class="badge badge-success" id="status-${index}">Stihne</span>`;

                const actions = `
                    <div class="action-buttons">
                        <button class="action-btn" onclick="openManual(${account.id}, '${result.unitsToSend.join(',')}', ${result.targetX}, ${result.targetY}, ${index})">üìù Ruƒçnƒõ</button>
                        <button class="action-btn auto" onclick="sendSupport(${account.id}, '${result.unitsToSend.join(',')}', ${result.targetX}, ${result.targetY}, ${index})">‚ö° Auto</button>
                    </div>
                `;

                return `
                    <tr id="row-${index}">
                        <td><strong>${account.village_name || account.username}</strong></td>
                        <td>${account.coord_x}|${account.coord_y}</td>
                        <td>${result.distance.toFixed(2)} pol√≠</td>
                        <td>${unitDisplay}</td>
                        <td>${travelTimeDisplay}</td>
                        <td>${sendTimeDisplay}</td>
                        <td>${statusBadge}</td>
                        <td>${actions}</td>
                    </tr>
                `;
            }).join('');

            // Aktualizovat nadpis s poƒçtem vesnic a jednotek
            const tribe = document.getElementById('tribe-select').value;
            const tribePart = tribe ? ` - Kmen: ${tribe}` : '';
            document.querySelector('.results-header h2').textContent = `üìä Dostupn√© mo≈ænosti podpory (${canSendCount} vesnic${totalUnitsText})${tribePart}`;

            // Aktualizovat calculationResults aby obsahovaly jen validn√≠ v√Ωsledky
            calculationResults = validResults;
        }

        function formatDateTime(date) {
            if (!date) return '-';
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${day}.${month}.${year} ${hours}:${minutes}:${seconds}`;
        }

        async function openManual(accountId, unitTypesStr, targetX, targetY, index) {
            try {
                // P≈ôev√©st string na pole
                const unitTypes = unitTypesStr.split(',');

                showMessage('Otev√≠r√°m browser s vyplnƒõn√Ωm formul√°≈ôem...', 'info');

                const response = await fetch('/api/support/open-manual', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        accountId,
                        unitTypes,
                        targetX,
                        targetY
                    })
                });

                if (response.ok) {
                    showMessage('Formul√°≈ô vyplnƒõn v browseru - zkontrolujte a ode≈°lete', 'success');

                    // Oznaƒçit jako vyplnƒõno
                    const statusEl = document.getElementById(`status-${index}`);
                    if (statusEl) {
                        statusEl.className = 'badge badge-info';
                        statusEl.textContent = 'üìù Vyplnƒõno';
                    }

                    // Zak√°zat v≈°echna tlaƒç√≠tka v tomto ≈ô√°dku
                    const row = document.getElementById(`row-${index}`);
                    if (row) {
                        const buttons = row.querySelectorAll('button');
                        buttons.forEach(btn => {
                            btn.disabled = true;
                            btn.style.opacity = '0.5';
                            btn.style.cursor = 'not-allowed';
                        });
                    }
                } else {
                    const error = await response.json();
                    showMessage('Chyba: ' + error.error, 'error');
                }
            } catch (error) {
                showMessage('Chyba p≈ôi otev√≠r√°n√≠: ' + error.message, 'error');
            }
        }

        async function sendSupport(accountId, unitTypesStr, targetX, targetY, index) {
            try {
                // P≈ôev√©st string na pole
                const unitTypes = unitTypesStr.split(',');

                // Z√≠skat jm√©no √∫ƒçtu pro log
                const account = calculationResults.find(r => r.account.id === accountId)?.account;
                const accountName = account?.username || `ID ${accountId}`;

                showMessage('Odes√≠l√°m podporu...', 'info');

                // Prodleva 2-4 sekundy p≈ôed odesl√°n√≠m
                const delay = 2000 + Math.random() * 2000; // 2-4s
                await new Promise(resolve => setTimeout(resolve, delay));

                const response = await fetch('/api/support/send', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        accountId,
                        unitTypes,  // Pole jednotek
                        targetX,
                        targetY
                    })
                });

                if (response.ok) {
                    showMessage('Podpora odesl√°na!', 'success');

                    // ZLEP≈†EN√ù LOG
                    console.log(`‚úÖ √öspƒõ≈°nƒõ odesl√°no z: ${accountName}`);

                    // Oznaƒçit jako odesl√°no
                    const statusEl = document.getElementById(`status-${index}`);
                    if (statusEl) {
                        statusEl.className = 'badge badge-sent';
                        statusEl.textContent = '‚úÖ Odesl√°no';
                    }

                    // Zak√°zat v≈°echna tlaƒç√≠tka v tomto ≈ô√°dku
                    const row = document.getElementById(`row-${index}`);
                    if (row) {
                        const buttons = row.querySelectorAll('button');
                        buttons.forEach(btn => {
                            btn.disabled = true;
                            btn.style.opacity = '0.5';
                            btn.style.cursor = 'not-allowed';
                        });
                    }
                } else {
                    const error = await response.json();
                    showMessage('Chyba: ' + error.error, 'error');
                    console.error(`‚ùå Chyba p≈ôi odesl√°n√≠ z ${accountName}:`, error.error);
                }
            } catch (error) {
                showMessage('Chyba p≈ôi odes√≠l√°n√≠: ' + error.message, 'error');
                console.error('‚ùå Chyba p≈ôi odes√≠l√°n√≠:', error);
            }
        }

        async function sendAllSupport() {
            const supportToSend = calculationResults.filter(r => r.fastestUnit !== null);

            if (supportToSend.length === 0) {
                showMessage('≈Ω√°dn√© podpory k odesl√°n√≠', 'error');
                return;
            }

            if (!confirm(`Opravdu chcete odeslat ${supportToSend.length} podpor?`)) {
                return;
            }

            showMessage(`Odes√≠l√°m ${supportToSend.length} podpor po skupin√°ch 2 √∫ƒçt≈Ø...`, 'info');

            let successCount = 0;
            let errorCount = 0;
            const successfulAccounts = [];
            const failedAccounts = [];

            // Pos√≠lat po skupin√°ch 2 √∫ƒçt≈Ø
            const batchSize = 2;
            for (let i = 0; i < supportToSend.length; i += batchSize) {
                const batch = supportToSend.slice(i, i + batchSize);

                console.log(`üì¶ Skupina ${Math.floor(i / batchSize) + 1}/${Math.ceil(supportToSend.length / batchSize)}: Odes√≠l√°m ${batch.length} podpor...`);

                // Zpracuj skupinu paralelnƒõ (v≈°ech 2 najednou)
                const batchPromises = batch.map(async (result, batchIndex) => {
                    const globalIndex = i + batchIndex;

                    try {
                        // Prodleva 2-4 sekundy p≈ôed odesl√°n√≠m
                        const delay = 2000 + Math.random() * 2000; // 2-4s
                        await new Promise(resolve => setTimeout(resolve, delay));

                        const response = await fetch('/api/support/send', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                accountId: result.account.id,
                                unitTypes: result.unitsToSend,
                                targetX: result.targetX,
                                targetY: result.targetY
                            })
                        });

                        if (response.ok) {
                            successCount++;
                            successfulAccounts.push(result.account.username);

                            // Oznaƒçit jako odesl√°no v UI
                            const statusEl = document.getElementById(`status-${globalIndex}`);
                            if (statusEl) {
                                statusEl.className = 'badge badge-sent';
                                statusEl.textContent = '‚úÖ Odesl√°no';
                            }

                            const row = document.getElementById(`row-${globalIndex}`);
                            if (row) {
                                const buttons = row.querySelectorAll('button');
                                buttons.forEach(btn => {
                                    btn.disabled = true;
                                    btn.style.opacity = '0.5';
                                    btn.style.cursor = 'not-allowed';
                                });
                            }

                            return { success: true, account: result.account.username };
                        } else {
                            errorCount++;
                            failedAccounts.push(result.account.username);
                            return { success: false, account: result.account.username };
                        }
                    } catch (error) {
                        errorCount++;
                        failedAccounts.push(result.account.username);
                        return { success: false, account: result.account.username, error: error.message };
                    }
                });

                // Poƒçkej na dokonƒçen√≠ cel√© skupiny
                await Promise.allSettled(batchPromises);

                console.log(`   ‚úì Skupina dokonƒçena (${successCount} √∫spƒõ≈°n√Ωch, ${errorCount} chyb)`);

                // Zobrazit progress
                showMessage(`Odesl√°no ${i + batch.length}/${supportToSend.length} (${successCount} OK, ${errorCount} chyb)`, 'info');

                // Prodleva 3-5 sekund mezi skupinami
                if (i + batchSize < supportToSend.length) {
                    const groupDelay = 3000 + Math.random() * 2000; // 3-5s
                    await new Promise(resolve => setTimeout(resolve, groupDelay));
                }
            }

            // ZLEP≈†EN√ù LOG - vypsat v√Ωsledky
            console.log('\n=== ‚úÖ √öSPƒö≈†Nƒö ODESL√ÅNO ===');
            if (successfulAccounts.length > 0) {
                successfulAccounts.forEach(account => {
                    console.log(`   ${account}`);
                });
            } else {
                console.log('   (≈æ√°dn√©)');
            }
            console.log('========================\n');

            if (failedAccounts.length > 0) {
                console.log('=== ‚ùå SELHALO ===');
                failedAccounts.forEach(account => {
                    console.log(`   ${account}`);
                });
                console.log('==================\n');
            }

            showMessage(`Dokonƒçeno: ${successCount} √∫spƒõ≈°nƒõ, ${errorCount} s chybou`, successCount > 0 ? 'success' : 'error');
        }

        function showMessage(text, type) {
            const message = document.getElementById('message');
            message.textContent = text;
            message.className = type;
            if (type !== 'info') {
                setTimeout(() => {
                    message.style.display = 'none';
                }, 5000);
            }
        }
    </script>
</body>
</html>
